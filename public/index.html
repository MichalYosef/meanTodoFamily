<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>To do app</title>
   
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">

    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.0/angular-route.min.js"></script>
    <!-- <script src="./scripts/client.js"></script> -->

</head>

<body ng-app="todoApp">
    <nav>
        <div class="nav-wrapper container">
            <a href="#" class="brand-logo">SPA Todo App</a>
            <ul class="right">
                <li>
                     <!-- Modal Trigger -->
                    <a href="#createModal" class="modal-trigger"><i class="material-icons">add</i></a>
                </li>
                <li><a href='#!/'>Home</a></li>
                <li><a href='#!/tasks'>Tasks</a></li>
            </ul>
        </div>
    </nav>

    <table ng-controller="familyCtrl" class="bordered striped highlight">
        <h4>Family members</h4>
        <thead>
          <tr>
              <th>Name</th>
              <th>Nick Name</th>
              <th>Family role</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="member in family_members">
            <td>{{member.name}}</td>
            <td>{{member.nickname}}</td>
            <td>{{member.family_role}}</td>
          </tr>
        </tbody>
    </table>
            
    <table ng-controller="taskCtrl" class="bordered striped highlight">
        <h4>Tasks</h4>
         <!-- Modal Trigger -->
         <a href="#createTaskModal" class="modal-trigger right" data-ng-click='loadFamilyMembers()'>Add new Task</i></a>
        <thead>
            <tr>
                <th>Description</th>
                <th>Creation date</th>
                <th>Family member</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="task in tasks">
            <td>{{task.description}}</td>
            <td>{{task.date}}</td>
            <td>{{task.name}}</td>
            <td ng-click="remove(task._id)"> Delete </td>
            </tr>
        </tbody>
    </table>
    
    <!-- Modal Structure -->
    <div ng-controller="taskCtrl" id="createTaskModal" class="modal">
        <div class="modal-content">
            <h4>New Task</h4>
            <br>
            <div class="input-field">
                <input type="text" id="description" ng-model="newtask.description">
                <label for="description">Description</label>
            </div>
            <div class="input-field">
                <select ng-model="newtask.family_member_id" ng-options="family_members.id as family_members.name for member in family_members"></select>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class="modal-action modal-close btn-flat" ng-click="create()">Create</a>
        </div>
    </div>
            
    
  
    <script type="text/javascript">
        
        // Initialize angular client app
        const app = angular.module('todoApp',[]);
     
        // This is the SERVICE that sends requests to the server

        app.service('talkToServer', function($http)
        {
            this.getFamilyMembers = function( onSuccess, onError ) 
            {
                $http.get('/family').then( onSuccess, onError);
            }

            this.getTasks = function( onSuccess, onError ) 
            {
                $http.get('/tasks').then(  onSuccess, onError);
            }

            this.createTask = function( newTask, onSuccess, onError ) 
            {
                $http.post('/tasks', newTask).then(  onSuccess, onError);
            }

        });

        // family controller

        app.controller('familyCtrl', function( $scope, talkToServer)
        {
            // $scope.description ='';
            talkToServer.getFamilyMembers( 
                function( response){ $scope.family_members = response.data },  //onSuccess
                function(response){ console.log('error ' + response )} // onError
            )

        })

        // tasks controller

        app.controller('taskCtrl', function($scope, $scope, talkToServer)
        {
            
            talkToServer.getTasks( 
                function( response){ $scope.tasks = response.data },  //onSuccess
                function(response){ console.log('error ' + response )} // onError
            )

            $scope.create = talkToServer.createTask( $scope.newTask,
                function( response){ $scope.tasks.push(response.data); newtask.description=''},  //onSuccess
                function(response){ console.log('error ' + response )} // onError
            )

            $scope.loadFamilyMembers = function(){
                // get family members to load into select for creating new task
                talkToServer.getFamilyMembers( 
                    function( response){ $scope.family_members = response.data },  //onSuccess
                    function(response){ console.log('error ' + response ); throw response;} // onError
                )
            }

            // $scope.create = function(){
            //     $http.post('/tasks', { description: $scope.description}).then(function(result){
            //         $scope.items.push(result.data)
            //     }).catch(function(er) {
            //         console.log(er)
            //     })
            //     $scope.description =''
            // }

            $scope.remove = function(id){

                console.log('delete ');
                // $http.delete('/tasks/' + id).then(function(result){
                //     if(result)
                //     {
                //         $http.get('/family').then( function(res){
                //             $scope.items = res.data;    
                //         })
                //     }
                // }).catch(function(er) {
                    
                //     console.log(er)
                // })
            }
        });

        $(document).ready(function()
        {
            $('.modal').modal();
        });

        // app.controller('todoCtrl', function($scope, $http)
        // {
        //     $scope.description ='';
        //     $http.get('/api/items').then( function(res){
        //         $scope.items = res.data;
        //     });

        //     $scope.remove = function(id){
        //         $http.delete('/api/items/' + id).then(function(result){
        //             if(result)
        //             {
        //                 $http.get('/api/items').then( function(res){
        //                     $scope.items = res.data;    
        //                 })
        //             }
        //         }).catch(function(er) {
                    
        //             console.log(er)
        //         })
        //     }

        //     $scope.create = function(){
        //         $http.post('/api/items', { description: $scope.description}).then(function(result){
        //             $scope.items.push(result.data)
        //         }).catch(function(er) {
        //             console.log(er)
        //         })
        //         $scope.description =''
        //     }
        

        // });


        



    </script>

         
</body>
</html>